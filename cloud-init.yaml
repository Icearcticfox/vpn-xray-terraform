#cloud-config
package_update: true
package_upgrade: true
packages:
  - curl
  - unzip
  - openssl
  - ca-certificates
  - jq

write_files:
  - path: /usr/local/bin/xray-update
    permissions: "0755"
    owner: root:root
    content: ${xray_update_script}
  - path: /usr/local/bin/xray-bootstrap
    permissions: "0755"
    owner: root:root
    content: ${xray_bootstrap_script}
  - path: /etc/systemd/system/xray.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Xray Service
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/xray run -c /etc/xray/config.json
      Restart=on-failure
      RestartSec=3

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/xray-update.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Update Xray binaries

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/xray-update
      ExecStartPost=/bin/systemctl restart xray.service
  - path: /etc/systemd/system/xray-update.timer
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Daily Xray update

      [Timer]
      OnBootSec=5m
      OnUnitActiveSec=1d
      Persistent=true

      [Install]
      WantedBy=timers.target

runcmd:
  - |
    echo "=========================================="
    echo "=== Starting Xray bootstrap ==="
    echo "=========================================="
    /usr/local/bin/xray-bootstrap 2>&1 | tee -a /var/log/xray-bootstrap.log
    BOOTSTRAP_EXIT=$?
    echo "=== Bootstrap exit code: $BOOTSTRAP_EXIT ==="
    if [ $BOOTSTRAP_EXIT -ne 0 ]; then
      echo "ERROR: Bootstrap failed with exit code $BOOTSTRAP_EXIT"
      exit $BOOTSTRAP_EXIT
    fi
  - |
    echo "=========================================="
    echo "=== Reloading systemd ==="
    echo "=========================================="
    systemctl daemon-reload
    echo "✓ Systemd reloaded"
  - |
    echo "=========================================="
    echo "=== Enabling and starting Xray service ==="
    echo "=========================================="
    systemctl enable xray.service
    echo "✓ Service enabled"
    systemctl start xray.service
    echo "✓ Service started"
    sleep 2
    echo ""
    echo "=== Xray service status ==="
    systemctl status xray.service --no-pager -l || true
    echo ""
    echo "=== Checking if Xray is running ==="
    if systemctl is-active --quiet xray.service; then
      echo "✓ Xray service is ACTIVE"
    else
      echo "✗ Xray service is NOT active"
      echo "=== Service logs ==="
      journalctl -u xray.service -n 20 --no-pager || true
    fi
  - |
    echo "=========================================="
    echo "=== Enabling Xray update timer ==="
    echo "=========================================="
    systemctl enable xray-update.timer
    systemctl start xray-update.timer
    echo "✓ Update timer enabled and started"
  - |
    echo "=========================================="
    echo "=== Final status check ==="
    echo "=========================================="
    echo ""
    echo "1. Xray binary:"
    if [ -f /usr/local/bin/xray ]; then
      echo "   ✓ Binary exists at /usr/local/bin/xray"
      /usr/local/bin/xray version 2>&1 | head -3 || echo "   ✗ Version check failed"
    else
      echo "   ✗ Binary NOT found"
    fi
    echo ""
    echo "2. Xray config:"
    if [ -f /etc/xray/config.json ]; then
      echo "   ✓ Config exists at /etc/xray/config.json"
      echo "   Config size: $(stat -c%s /etc/xray/config.json) bytes"
    else
      echo "   ✗ Config NOT found"
    fi
    echo ""
    echo "3. Credentials file:"
    if [ -f /root/xray-credentials.json ]; then
      echo "   ✓ Credentials exist at /root/xray-credentials.json"
      echo "   UUID: $(jq -r '.uuid' /root/xray-credentials.json | cut -c1-8)..."
    else
      echo "   ✗ Credentials NOT found"
    fi
    echo ""
    echo "4. Xray service:"
    if systemctl is-active --quiet xray.service; then
      echo "   ✓ Service is ACTIVE"
      echo "   Service status: $(systemctl is-active xray.service)"
    else
      echo "   ✗ Service is NOT active"
      echo "   Service status: $(systemctl is-active xray.service || echo 'inactive')"
    fi
    echo ""
    echo "5. Xray listening ports:"
    PORT=$(jq -r '.inbounds[0].port // empty' /etc/xray/config.json 2>/dev/null || echo "")
    if [ -n "$PORT" ]; then
      if ss -tlnp 2>/dev/null | grep -q ":$PORT "; then
        echo "   ✓ Listening on port $PORT"
      else
        echo "   ✗ NOT listening on port $PORT"
      fi
    else
      echo "   ? Could not determine port from config"
    fi
    echo ""
    echo "6. Process check:"
    if pgrep -x xray > /dev/null; then
      echo "   ✓ Xray process is running (PID: $(pgrep -x xray))"
    else
      echo "   ✗ Xray process is NOT running"
    fi
    echo ""
    echo "=========================================="
    echo "=== Bootstrap completed ==="
    echo "=========================================="
