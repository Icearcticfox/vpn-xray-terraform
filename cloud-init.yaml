#cloud-config
package_update: true
package_upgrade: true
packages:
  - curl
  - unzip
  - openssl
  - ca-certificates
  - jq

write_files:
  - path: /usr/local/bin/xray-update
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      echo "[xray-update] Starting Xray update..."
      arch="linux-64"
      tmpdir=$(mktemp -d)
      trap "rm -rf $tmpdir" EXIT
      
      echo "[xray-update] Fetching latest release tag..."
      tag=$(curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r '.tag_name // empty')
      if [ -z "$tag" ] || [ "$tag" = "null" ]; then
        echo "[xray-update] ERROR: Failed to determine Xray release tag" >&2
        exit 1
      fi
      echo "[xray-update] Latest tag: $tag"
      
      current=""
      if [ -f /usr/local/share/xray/version ]; then
        current=$(cat /usr/local/share/xray/version)
        echo "[xray-update] Current version: $current"
      else
        echo "[xray-update] No current version found, will install"
      fi
      
      if [ "$tag" = "$current" ]; then
        echo "[xray-update] Already up to date, skipping"
        exit 0
      fi
      
      echo "[xray-update] Downloading Xray $tag..."
      url="https://github.com/XTLS/Xray-core/releases/download/$${tag}/Xray-$${arch}.zip"
      if ! curl -fsSL "$url" -o "$tmpdir/xray.zip"; then
        echo "[xray-update] ERROR: Failed to download Xray" >&2
        exit 1
      fi
      
      echo "[xray-update] Extracting..."
      if ! unzip -q "$tmpdir/xray.zip" -d "$tmpdir"; then
        echo "[xray-update] ERROR: Failed to extract Xray" >&2
        exit 1
      fi
      
      echo "[xray-update] Installing files..."
      install -d /usr/local/bin /usr/local/share/xray
      install -m 755 "$tmpdir/xray" /usr/local/bin/xray
      install -m 644 "$tmpdir/geoip.dat" /usr/local/share/xray/geoip.dat
      install -m 644 "$tmpdir/geosite.dat" /usr/local/share/xray/geosite.dat
      echo "$tag" > /usr/local/share/xray/version
      
      echo "[xray-update] Verifying installation..."
      if /usr/local/bin/xray version > /dev/null 2>&1; then
        echo "[xray-update] Successfully installed Xray $tag"
      else
        echo "[xray-update] ERROR: Xray installation verification failed" >&2
        exit 1
      fi
  - path: /usr/local/bin/xray-bootstrap
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      
      echo "[xray-bootstrap] Starting Xray bootstrap..."
      XRAY_PORT=${xray_port}
      XRAY_SERVER_NAME="${xray_server_name}"
      echo "[xray-bootstrap] Port: $${XRAY_PORT}, Server Name: $${XRAY_SERVER_NAME}"

      echo "[xray-bootstrap] Updating Xray..."
      if ! /usr/local/bin/xray-update; then
        echo "[xray-bootstrap] ERROR: Failed to update Xray" >&2
        exit 1
      fi

      if [ ! -f /etc/xray/config.json ]; then
        echo "[xray-bootstrap] Generating new configuration..."
        uuid=$(cat /proc/sys/kernel/random/uuid)
        echo "[xray-bootstrap] Generated UUID: $${uuid:0:8}..."
        
        echo "[xray-bootstrap] Generating X25519 keys..."
        if ! keys=$(/usr/local/bin/xray x25519 2>&1); then
          echo "[xray-bootstrap] ERROR: Failed to generate X25519 keys" >&2
          echo "[xray-bootstrap] Xray output: $keys" >&2
          exit 1
        fi
        private_key=$(echo "$keys" | awk '/Private key/ {print $3}')
        public_key=$(echo "$keys" | awk '/Public key/ {print $3}')
        echo "[xray-bootstrap] Generated keys: Public=$${public_key:0:16}..."
        
        short_id=$(openssl rand -hex 8)
        echo "[xray-bootstrap] Generated Short ID: $${short_id}"

        mkdir -p /etc/xray

        cat > /etc/xray/config.json <<CONFIG
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "listen": "0.0.0.0",
      "port": $${XRAY_PORT},
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$${uuid}",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "$${XRAY_SERVER_NAME}:443",
          "xver": 0,
          "serverNames": [
            "$${XRAY_SERVER_NAME}"
          ],
          "privateKey": "$${private_key}",
          "shortIds": [
            "$${short_id}"
          ]
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    }
  ]
}
CONFIG

        # Save credentials for Terraform to generate client configs
        echo "[xray-bootstrap] Saving credentials..."
        cat > /root/xray-credentials.json <<CREDS
{
  "uuid": "$${uuid}",
  "public_key": "$${public_key}",
  "short_id": "$${short_id}"
}
CREDS
        echo "[xray-bootstrap] Configuration saved successfully"
      else
        echo "[xray-bootstrap] Configuration already exists, skipping generation"
      fi
      
      echo "[xray-bootstrap] Bootstrap completed successfully"
  - path: /etc/systemd/system/xray.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Xray Service
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/local/bin/xray run -c /etc/xray/config.json
      Restart=on-failure
      RestartSec=3

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/xray-update.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Update Xray binaries

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/xray-update
      ExecStartPost=/bin/systemctl restart xray.service
  - path: /etc/systemd/system/xray-update.timer
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Daily Xray update

      [Timer]
      OnBootSec=5m
      OnUnitActiveSec=1d
      Persistent=true

      [Install]
      WantedBy=timers.target

runcmd:
  - |
    echo "=== Starting Xray bootstrap ==="
    /usr/local/bin/xray-bootstrap 2>&1 | tee -a /var/log/xray-bootstrap.log
    echo "=== Bootstrap exit code: $? ==="
  - |
    echo "=== Reloading systemd ==="
    systemctl daemon-reload
  - |
    echo "=== Enabling and starting Xray service ==="
    systemctl enable xray.service
    systemctl start xray.service
    systemctl status xray.service || true
  - |
    echo "=== Enabling Xray update timer ==="
    systemctl enable xray-update.timer
    systemctl start xray-update.timer
  - |
    echo "=== Final status check ==="
    echo "Xray service status:"
    systemctl is-active xray.service || echo "Service not active"
    echo "Xray binary:"
    /usr/local/bin/xray version || echo "Xray not found"
    echo "Config file:"
    test -f /etc/xray/config.json && echo "Config exists" || echo "Config NOT found"
    echo "Credentials file:"
    test -f /root/xray-credentials.json && echo "Credentials exist" || echo "Credentials NOT found"
