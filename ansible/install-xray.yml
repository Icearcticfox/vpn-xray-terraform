---
- hosts: all
  become: yes
  gather_facts: false

  vars:
    xray_arch: linux-64

  tasks:
    - name: Install dependencies
      apt:
        name:
          - curl
          - unzip
          - jq
          - openssl
        update_cache: yes
        state: present

    - name: Get latest Xray tag
      shell: curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r '.tag_name'
      register: xray_tag

    - name: Download Xray archive (latest)
      get_url:
        url: "https://github.com/XTLS/Xray-core/releases/download/{{ xray_tag.stdout }}/Xray-{{ xray_arch }}.zip"
        dest: /tmp/xray.zip
        mode: '0644'

    - name: Ensure temp dir exists
      file:
        path: /tmp/xray
        state: directory
        mode: '0755'

    - name: Unzip Xray archive
      unarchive:
        src: /tmp/xray.zip
        dest: /tmp/xray
        remote_src: yes

    - name: Install Xray binaries and data (always)
      shell: |
        set -e
        install -d /usr/local/bin /usr/local/share/xray
        install -m 755 /tmp/xray/xray /usr/local/bin/xray
        install -m 644 /tmp/xray/geoip.dat /usr/local/share/xray/geoip.dat
        install -m 644 /tmp/xray/geosite.dat /usr/local/share/xray/geosite.dat
        echo "{{ xray_tag.stdout }}" > /usr/local/share/xray/version

    - name: Cleanup temp files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/xray
        - /tmp/xray.zip

    - name: Ensure /etc/xray exists
      file:
        path: /etc/xray
        state: directory
        mode: '0755'

    - name: Generate UUID
      command: cat /proc/sys/kernel/random/uuid
      register: xray_uuid_cmd

    - name: Generate Reality keys (Xray 25.x uses Password as public key)
      command: /usr/local/bin/xray x25519
      register: xray_x25519_cmd

    - name: Generate Short ID
      command: openssl rand -hex 8
      register: xray_short_id_cmd

    - name: Parse Reality keys
      set_fact:
        xray_uuid: "{{ xray_uuid_cmd.stdout | trim }}"
        xray_private_key: "{{ (xray_x25519_cmd.stdout | regex_findall('PrivateKey:\\s*([^\\s]+)') | first | default('')) | trim }}"
        xray_public_key: "{{ (xray_x25519_cmd.stdout | regex_findall('(?:Password|PublicKey):\\s*([^\\s]+)') | first | default('')) | trim }}"
        xray_short_id: "{{ xray_short_id_cmd.stdout | trim }}"

    - name: Write Xray config (always)
      copy:
        dest: /etc/xray/config.json
        mode: '0644'
        content: |
          {
            "log": { "loglevel": "warning" },
            "inbounds": [{
              "listen": "0.0.0.0",
              "port": {{ xray_port }},
              "protocol": "vless",
              "settings": {
                "clients": [{ "id": "{{ xray_uuid }}", "flow": "xtls-rprx-vision" }],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "{{ xray_server_name }}:443",
                  "xver": 0,
                  "serverNames": ["{{ xray_server_name }}"],
                  "privateKey": "{{ xray_private_key }}",
                  "shortIds": ["{{ xray_short_id }}"]
                }
              }
            }],
            "outbounds": [{ "protocol": "freedom", "tag": "direct" }]
          }

    - name: Write credentials (always)
      copy:
        dest: /root/xray-credentials.json
        mode: '0600'
        content: |
          {
            "uuid": "{{ xray_uuid }}",
            "public_key": "{{ xray_public_key }}",
            "short_id": "{{ xray_short_id }}"
          }

    - name: Validate config
      command: /usr/local/bin/xray -test -c /etc/xray/config.json

    - name: Install systemd unit
      copy:
        dest: /etc/systemd/system/xray.service
        mode: '0644'
        content: |
          [Unit]
          Description=Xray Service
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/xray run -c /etc/xray/config.json
          Restart=on-failure
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: Enable and restart Xray
      systemd:
        name: xray
        enabled: yes
        state: restarted
        daemon_reload: yes
