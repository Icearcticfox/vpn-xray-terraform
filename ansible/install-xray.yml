---
- hosts: all
  become: yes
  gather_facts: false

  vars:
    xray_arch: linux-64
    xray_force_regen: false
    xray_binary_stat:
      stat:
        exists: false
    xray_config_stat:
      stat:
        exists: false
    xray_creds_valid: false
    xray_config_valid: false

  tasks:
    - name: Check xray binary presence
      stat:
        path: /usr/local/bin/xray
      register: xray_binary_stat
      changed_when: false

    - name: Read current Xray version if present
      shell: cat /usr/local/share/xray/version
      register: xray_current_version
      changed_when: false
      failed_when: false
      when: xray_binary_stat.stat.exists

    - name: Check config presence
      stat:
        path: /etc/xray/config.json
      register: xray_config_stat
      changed_when: false
      failed_when: false

    - name: Read existing config if present
      slurp:
        path: /etc/xray/config.json
      register: config_slurp
      when: xray_config_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Parse existing config
      set_fact:
        xray_config_valid: >-
          {{
            (cfg | length > 0)
            and (cfg.inbounds is defined)
            and (cfg.inbounds | length > 0)
            and (cfg.inbounds[0].streamSettings is defined)
            and (cfg.inbounds[0].streamSettings.realitySettings is defined)
            and (cfg.inbounds[0].streamSettings.realitySettings.privateKey | default('') | length > 0)
            and (cfg.inbounds[0].streamSettings.realitySettings.shortIds | default([]) | length > 0)
          }}
        xray_config_private_key: "{{ cfg.inbounds[0].streamSettings.realitySettings.privateKey | default('') }}"
        xray_config_short_id: "{{ (cfg.inbounds[0].streamSettings.realitySettings.shortIds | default([])) | first | default('') }}"
      vars:
        cfg: "{{ (config_slurp.content | b64decode | from_json) if (config_slurp is defined and config_slurp.content is defined) else {} }}"
      when: xray_config_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Get latest Xray tag
      shell: |
        set -e
        curl -fsSL https://api.github.com/repos/XTLS/Xray-core/releases/latest | jq -r '.tag_name'
      register: xray_tag
      changed_when: false

    - name: Decide if Xray install/update needed
      set_fact:
        xray_install_needed: "{{ (not xray_binary_stat.stat.exists) or (xray_tag.stdout | default('') != (xray_current_version.stdout | default(''))) }}"
      changed_when: false

    - name: Check credentials presence
      stat:
        path: /root/xray-credentials.json
      register: creds_stat
      changed_when: false

    - name: Read existing credentials if present
      slurp:
        path: /root/xray-credentials.json
      register: creds_slurp
      when: creds_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Parse existing credentials
      set_fact:
        xray_creds_valid: >-
          {{
            (creds | length > 0)
            and (creds.uuid is defined and creds.uuid | length > 0)
            and (creds.public_key is defined and creds.public_key | length > 0)
            and (creds.short_id is defined and creds.short_id | length > 0)
          }}
        xray_existing_uuid: "{{ creds.uuid | default('') }}"
        xray_existing_public_key: "{{ creds.public_key | default('') }}"
        xray_existing_short_id: "{{ creds.short_id | default('') }}"
      vars:
        creds: "{{ (creds_slurp.content | b64decode | from_json) if (creds_slurp is defined and creds_slurp.content is defined) else {} }}"
      when: creds_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Decide if regeneration needed
      set_fact:
        xray_regen_needed: >-
          {{
            xray_force_regen | bool
            or (not creds_stat.stat.exists)
            or (not xray_creds_valid)
            or (not xray_config_stat.stat.exists)
            or (not xray_config_valid)
          }}
      changed_when: false

    - name: Install dependencies
      apt:
        name:
          - curl
          - unzip
          - jq
        update_cache: yes
        state: present

    - name: Download Xray archive
      get_url:
        url: "https://github.com/XTLS/Xray-core/releases/download/{{ xray_tag.stdout }}/Xray-{{ xray_arch }}.zip"
        dest: /tmp/xray.zip
        mode: '0644'
      when: xray_install_needed

    - name: Ensure install directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /tmp/xray
        - /usr/local/share/xray
      when: xray_install_needed

    - name: Unzip Xray archive
      unarchive:
        src: /tmp/xray.zip
        dest: /tmp/xray
        remote_src: yes
        creates: /tmp/xray/xray
      when: xray_install_needed

    - name: Install Xray binaries and data
      shell: |
        set -e
        install -d /usr/local/bin /usr/local/share/xray
        install -m 755 /tmp/xray/xray /usr/local/bin/xray
        install -m 644 /tmp/xray/geoip.dat /usr/local/share/xray/geoip.dat
        install -m 644 /tmp/xray/geosite.dat /usr/local/share/xray/geosite.dat
        echo "{{ xray_tag.stdout }}" > /usr/local/share/xray/version
      args:
        creates: /usr/local/bin/xray
      when: xray_install_needed

    - name: Clean temp files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/xray
        - /tmp/xray.zip
      when: xray_install_needed

    - name: Generate keys and ids
      shell: |
        set -e
        UUID=$(cat /proc/sys/kernel/random/uuid)
        KEYS=$(/usr/local/bin/xray x25519)
        PRIVATE_KEY=$(echo "$KEYS" | awk '/Private key/ {print $3}')
        PUBLIC_KEY=$(echo "$KEYS" | awk '/Public key/ {print $3}')
        SHORT_ID=$(openssl rand -hex 8)
        echo "UUID=$UUID"
        echo "PRIVATE_KEY=$PRIVATE_KEY"
        echo "PUBLIC_KEY=$PUBLIC_KEY"
        echo "SHORT_ID=$SHORT_ID"
      register: xray_keys
      changed_when: false
      when: xray_regen_needed

    - name: Parse generated values
      set_fact:
        xray_uuid: "{{ xray_keys.stdout_lines | select('match','^UUID=') | list | first | regex_replace('^UUID=','') }}"
        xray_private_key: "{{ xray_keys.stdout_lines | select('match','^PRIVATE_KEY=') | list | first | regex_replace('^PRIVATE_KEY=','') }}"
        xray_public_key: "{{ xray_keys.stdout_lines | select('match','^PUBLIC_KEY=') | list | first | regex_replace('^PUBLIC_KEY=','') }}"
        xray_short_id: "{{ xray_keys.stdout_lines | select('match','^SHORT_ID=') | list | first | regex_replace('^SHORT_ID=','') }}"
      when: xray_regen_needed

    - name: Ensure config directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/xray
      when: xray_regen_needed

    - name: Write Xray config
      copy:
        dest: /etc/xray/config.json
        mode: '0644'
        content: |
          {
            "log": { "loglevel": "warning" },
            "inbounds": [{
              "listen": "0.0.0.0",
              "port": {{ xray_port }},
              "protocol": "vless",
              "settings": {
                "clients": [{ "id": "{{ xray_uuid }}", "flow": "xtls-rprx-vision" }],
                "decryption": "none"
              },
              "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                  "show": false,
                  "dest": "{{ xray_server_name }}:443",
                  "xver": 0,
                  "serverNames": ["{{ xray_server_name }}"],
                  "privateKey": "{{ xray_private_key }}",
                  "shortIds": ["{{ xray_short_id }}"]
                }
              }
            }],
            "outbounds": [{ "protocol": "freedom", "tag": "direct" }]
          }
      when: xray_regen_needed
      notify: Restart xray

    - name: Write credentials
      copy:
        dest: /root/xray-credentials.json
        mode: '0600'
        content: |
          {
            "uuid": "{{ xray_uuid }}",
            "public_key": "{{ xray_public_key }}",
            "short_id": "{{ xray_short_id }}"
          }
      when: xray_regen_needed

    - name: Validate Xray config
      shell: /usr/local/bin/xray -test -c /etc/xray/config.json
      register: xray_config_test
      changed_when: false
      failed_when: xray_config_test.rc != 0
      when: xray_regen_needed or xray_install_needed

    - name: Systemd unit for Xray
      copy:
        dest: /etc/systemd/system/xray.service
        mode: '0644'
        content: |
          [Unit]
          Description=Xray Service
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          ExecStart=/usr/local/bin/xray run -c /etc/xray/config.json
          Restart=on-failure
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: Enable and start Xray
      systemd:
        name: xray
        enabled: yes
        state: started

  handlers:
    - name: Restart xray
      systemd:
        name: xray
        enabled: yes
        state: restarted
